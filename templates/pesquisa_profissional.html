{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 mb-0 d-flex align-items-center gap-2">
        <i class="fas fa-search text-primary" style="font-size: 1.8rem;"></i>
        <span>Pesquisa Profissional Apto ao Voto</span>
      </h1>
    </div>

    <!-- Mensagens de feedback -->
    {% if success_message %}
    <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert" style="animation: fadeIn 0.4s ease-out;">
      <i class="fas fa-check-circle me-2"></i>{{ success_message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert" style="animation: fadeIn 0.4s ease-out;">
      <i class="fas fa-exclamation-triangle me-2"></i>{{ error_message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Upload do CSV (apenas para administradores) -->
    {% if can_access_reports %}
    <div class="card mb-4 shadow-lg" style="border-radius: 20px;">
      <div class="card-body p-4">
        <h5 class="card-title d-flex align-items-center gap-2 mb-3">
          <i class="fas fa-file-upload text-success" style="font-size: 1.3rem;"></i>
          <span>Importar Planilha de Profissionais</span>
        </h5>
        <p class="text-muted mb-3">
          Faça upload de um arquivo Excel (XLS, XLSX) ou CSV contendo os dados dos profissionais aptos ao voto. 
          O arquivo deve conter as colunas obrigatórias: <strong>nome</strong> e <strong>numero_cro</strong>.<br>
          Colunas opcionais: <strong>CATEGORIA</strong>, <strong>CPF</strong>, <strong>EMAIL</strong>, <strong>OUTROS_EMAILS</strong>, 
          <strong>CELULAR_ATUALIZADO</strong>, <strong>OUTROS_TELEFONES</strong>. As colunas podem estar em qualquer ordem.
        </p>
        
        <form method="post" action="/upload-csv-profissionais" enctype="multipart/form-data">
          <div class="row align-items-end g-3">
            <div class="col-md-8">
              <label class="form-label fw-semibold d-flex align-items-center gap-2">
                <i class="fas fa-file-excel text-success"></i>
                Arquivo Planilha
              </label>
              <input type="file" name="csv_file" class="form-control" accept=".csv,.xls,.xlsx" required>
              <small class="text-muted">Arquivos suportados: .csv, .xls, .xlsx</small>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-success w-100 shadow-hover">
                <i class="fas fa-upload me-2"></i>Importar Planilha
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Formulário de pesquisa -->
    <div class="card mb-4 shadow-lg" style="border-radius: 20px;">
      <div class="card-body p-4">
        <h5 class="card-title d-flex align-items-center gap-2 mb-3">
          <i class="fas fa-search text-primary" style="font-size: 1.3rem;"></i>
          <span>Buscar Profissional</span>
        </h5>
        <p class="text-muted mb-3">
          Digite o nome completo do profissional ou o número de inscrição para encontrar suas informações.
        </p>
        
        <div class="row g-3">
          <div class="col-md-8">
            <input 
              type="text" 
              id="searchInput" 
              class="form-control form-control-lg" 
              placeholder="Digite o nome completo ou número de inscrição..." 
              autocomplete="off"
            >
            <small class="text-muted">Digite pelo menos 2 caracteres para iniciar a busca</small>
          </div>
          <div class="col-md-4">
            <button id="searchBtn" class="btn btn-primary btn-lg w-100 shadow-hover">
              <i class="fas fa-search me-2"></i>Buscar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="text-center py-5" style="display: none;">
      <div class="spinner" style="margin: 0 auto;"></div>
      <p class="mt-3 text-muted fw-medium">Buscando profissionais...</p>
    </div>

    <!-- Resultados da pesquisa -->
    <div id="results" class="card shadow-lg" style="display: none; border-radius: 20px;">
      <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(74, 144, 226, 0.15));">
        <h5 class="mb-0 d-flex align-items-center gap-2">
          <i class="fas fa-list text-primary"></i>
          Resultados da Pesquisa
        </h5>
        <span id="resultCount" class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);">0</span>
      </div>
      <div class="card-body p-4" id="resultsList">
        <!-- Resultados serão inseridos aqui via JavaScript -->
      </div>
    </div>

    <!-- Mensagem quando não há resultados -->
    <div id="noResults" class="card shadow-lg" style="display: none; border-radius: 20px;">
      <div class="card-body text-center py-5">
        <i class="fas fa-search text-muted mb-3" style="font-size: 4rem; opacity: 0.3;"></i>
        <h5 class="text-muted mb-2">Nenhum profissional encontrado</h5>
        <p class="text-muted mb-0">Tente pesquisar com outros termos ou verifique se o CSV foi importado corretamente.</p>
      </div>
    </div>
  </div>
</div>

<script>
// Variáveis globais
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const loading = document.getElementById('loading');
const results = document.getElementById('results');
const noResults = document.getElementById('noResults');
const resultsList = document.getElementById('resultsList');
const resultCount = document.getElementById('resultCount');

// Função para realizar a pesquisa
async function performSearch(query) {
  if (!query || query.length < 2) {
    hideResults();
    return;
  }

  showLoading();

  try {
    const response = await fetch(`/api/pesquisar-profissional?q=${encodeURIComponent(query)}`);
    
    if (!response.ok) {
      throw new Error(`Erro ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    
    hideLoading();
    displayResults(data);
    
  } catch (error) {
    hideLoading();
    showError('Erro ao buscar profissionais: ' + error.message);
  }
}

// Função para mostrar loading
function showLoading() {
  loading.style.display = 'block';
  results.style.display = 'none';
  noResults.style.display = 'none';
}

// Função para esconder loading
function hideLoading() {
  loading.style.display = 'none';
}

// Função para esconder resultados
function hideResults() {
  results.style.display = 'none';
  noResults.style.display = 'none';
  hideLoading();
}

// Função para exibir resultados
function displayResults(data) {
  if (!data.results || data.results.length === 0) {
    results.style.display = 'none';
    noResults.style.display = 'block';
    return;
  }

  resultCount.textContent = data.total;
  resultsList.innerHTML = '';

  data.results.forEach(profissional => {
    const card = createProfissionalCard(profissional);
    resultsList.appendChild(card);
  });

  results.style.display = 'block';
  noResults.style.display = 'none';
}

// Função para criar card de profissional
function createProfissionalCard(profissional) {
  const div = document.createElement('div');
  div.className = 'mb-3';
  
  // Preparar outras informações
  let outrasInfo = '';
  if (profissional.outras_informacoes && Object.keys(profissional.outras_informacoes).length > 0) {
    outrasInfo = Object.entries(profissional.outras_informacoes)
      .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
      .join('<br>');
  }
  
  div.innerHTML = `
    <div class="border rounded p-3 bg-light">
      <div class="row">
        <div class="col-md-8">
          <h6 class="mb-2 text-primary">
            <i class="fas fa-user me-2"></i>${profissional.nome}
          </h6>
          
          <div class="row mb-2">
            <div class="col-md-6">
              <p class="mb-1">
                <strong>Inscrição:</strong> 
                <span class="badge bg-secondary">${profissional.numero_cro}</span>
              </p>
              ${profissional.categoria ? `
              <p class="mb-1">
                <strong>Categoria:</strong> 
                <span class="text-muted">${profissional.categoria}</span>
              </p>
              ` : ''}
              ${profissional.cpf ? `
              <p class="mb-1">
                <strong>CPF:</strong> 
                <span class="text-muted">${profissional.cpf}</span>
              </p>
              ` : ''}
            </div>
            <div class="col-md-6">
              ${profissional.email ? `
              <p class="mb-1">
                <strong>Email:</strong><br>
                <span class="text-muted small">${profissional.email}</span>
              </p>
              ` : ''}
              ${profissional.outros_emails ? `
              <p class="mb-1">
                <strong>Outros Emails:</strong><br>
                <span class="text-muted small">${profissional.outros_emails}</span>
              </p>
              ` : ''}
            </div>
          </div>
          
          <div class="row mb-2">
            <div class="col-md-6">
              ${profissional.celular_atualizado ? `
              <p class="mb-1">
                <strong>Celular Atualizado:</strong> 
                <span class="text-muted">${profissional.celular_atualizado}</span>
              </p>
              ` : ''}
            </div>
            <div class="col-md-6">
              ${profissional.outros_telefones ? `
              <p class="mb-1">
                <strong>Outros Telefones:</strong> 
                <span class="text-muted">${profissional.outros_telefones}</span>
              </p>
              ` : ''}
            </div>
          </div>
          
          ${profissional.situacao ? `
          <p class="mb-1">
            <strong>Situação:</strong> 
            <span class="badge ${getSituacaoBadgeClass(profissional.situacao)}">${profissional.situacao}</span>
          </p>
          ` : ''}
          
          ${outrasInfo ? `
          <div class="mt-2">
            <strong>Outras Informações:</strong><br>
            <small class="text-muted">${outrasInfo}</small>
          </div>
          ` : ''}
        </div>
        <div class="col-md-4 text-end">
          <small class="text-muted">
            <i class="fas fa-clock me-1"></i>Importado em<br>
            ${profissional.data_importacao}
          </small>
        </div>
      </div>
    </div>
  `;
  
  return div;
}

// Função para determinar classe do badge da situação
function getSituacaoBadgeClass(situacao) {
  const s = situacao.toLowerCase();
  if (s.includes('apto') || s.includes('ativo')) return 'bg-success';
  if (s.includes('não apto') || s.includes('inativo')) return 'bg-danger';
  if (s.includes('pendente') || s.includes('análise')) return 'bg-warning';
  return 'bg-secondary';
}

// Função para mostrar erros
function showError(message) {
  const alertDiv = document.createElement('div');
  alertDiv.className = 'alert alert-danger alert-dismissible fade show';
  alertDiv.innerHTML = `
    <i class="fas fa-exclamation-triangle me-2"></i>${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  const container = document.querySelector('.col-12');
  container.insertBefore(alertDiv, container.firstChild.nextSibling);
  
  // Auto-remover após 5 segundos
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}

// Event listeners
searchInput.addEventListener('input', (e) => {
  const query = e.target.value.trim();
  
  // Debounce para evitar muitas requisições
  clearTimeout(searchInput.debounceTimer);
  
  if (query.length >= 2) {
    searchInput.debounceTimer = setTimeout(() => {
      performSearch(query);
    }, 300);
  } else if (query.length === 0) {
    hideResults();
  }
});

searchInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    performSearch(e.target.value.trim());
  }
});

searchBtn.addEventListener('click', () => {
  performSearch(searchInput.value.trim());
});

// Focus no input ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
  searchInput.focus();
});
</script>
{% endblock %}