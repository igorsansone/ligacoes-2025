{% extends "base.html" %}
{% block content %}

<!-- Cabeçalho específico para impressão (aparece no PDF) -->
<div class="only-print mb-3">
  <div class="d-flex align-items-center gap-3">
    <img src="/static/logo-crors.png" alt="CRO/RS" class="print-logo" onerror="this.style.display='none'">
    <div>
      <h5 class="mb-0">ELEIÇÕES CRORS - 2025</h5>
      <small>Relatórios de ligações</small>
    </div>
  </div>
  <hr>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="m-0">Relatórios e Gráficos</h4>
  <div class="no-print d-flex gap-2">
    <button class="btn btn-outline-secondary" onclick="window.print()">Imprimir / Salvar PDF</button>
    <a class="btn btn-outline-primary" href="/">Voltar ao cadastro</a>
  </div>
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-4 no-print">
  <div class="card-body">
    <form class="row g-3 align-items-end">
      <div class="col-sm-3">
        <label class="form-label">Início</label>
        <input type="date" id="fStart" class="form-control">
      </div>
      <div class="col-sm-3">
        <label class="form-label">Fim</label>
        <input type="date" id="fEnd" class="form-control">
      </div>
      <div class="col-sm-4">
        <label class="form-label">Tipo de Dúvida (multi)</label>
        <select id="fTipos" class="form-select" multiple size="4">
          {% for opt in duvida_opcoes %}
          <option value="{{ opt }}">{{ opt }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Segure CTRL (ou CMD) para selecionar múltiplos.</div>
      </div>
      <div class="col-sm-2 d-flex gap-2">
        <button type="button" id="btnAplicar" class="btn btn-primary w-100">Aplicar</button>
        <button type="button" id="btnLimpar" class="btn btn-outline-secondary">Limpar</button>
      </div>
    </form>
  </div>
</div>

<div class="row g-4">
  <!-- Por Tipo -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title m-0">Distribuição por Tipo de Dúvida</h6>
          <div class="no-print d-flex gap-2">
            <button id="btnTipoBar" class="btn btn-sm btn-outline-primary">Barra</button>
            <button id="btnTipoPie" class="btn btn-sm btn-outline-primary">Pizza</button>
            <button id="btnTipoDownload" class="btn btn-sm btn-outline-secondary">Baixar PNG</button>
          </div>
        </div>
        <canvas id="chartDuvida"></canvas>
        <div class="small text-muted mt-2" id="totalDuvidas"></div>
      </div>
    </div>
  </div>

  <!-- Por Dia -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title m-0">Ligações por Dia (BR/RS)</h6>
          <div class="no-print d-flex flex-wrap gap-2">
            <div class="form-check me-2">
              <input class="form-check-input" type="checkbox" id="chkMedia">
              <label class="form-check-label" for="chkMedia">Média móvel 7d</label>
            </div>
            <button id="btnZoomReset" class="btn btn-sm btn-outline-secondary">Reset Zoom</button>
            <button id="btnDiaDownload" class="btn btn-sm btn-outline-secondary">Baixar PNG</button>
          </div>
        </div>
        <canvas id="chartDia"></canvas>
        <div class="form-text mt-2">Arraste para **zoom** (horizontal). Use a roda do mouse para zoom. Segure **Alt** para pan.</div>
      </div>
    </div>
  </div>
</div>

<!-- Novos relatórios -->
<div class="row g-4 mt-2">
  <!-- Comparativo por Período -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title m-0">Comparativo por Período</h6>
          <div class="no-print d-flex gap-2">
            <select id="selPeriodo" class="form-select form-select-sm" style="width: auto;">
              <option value="dia">Por Dia</option>
              <option value="semana">Por Semana</option>
              <option value="mes">Por Mês</option>
              <option value="ano">Por Ano</option>
            </select>
            <button id="btnComparativoDownload" class="btn btn-sm btn-outline-secondary">Baixar PNG</button>
          </div>
        </div>
        <canvas id="chartComparativo"></canvas>
        <div class="small text-muted mt-2" id="totalComparativo"></div>
      </div>
    </div>
  </div>

  <!-- Pico de Horários -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title m-0">Pico de Horários</h6>
          <div class="no-print d-flex gap-2">
            <button id="btnHorarioDownload" class="btn btn-sm btn-outline-secondary">Baixar PNG</button>
          </div>
        </div>
        <canvas id="chartHorario"></canvas>
        <div class="small text-muted mt-2" id="totalHorarios"></div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-2">
  <!-- Por Atendente -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title m-0">Ligações por Atendente</h6>
          <div class="no-print d-flex gap-2">
            <button id="btnAtendenteBarra" class="btn btn-sm btn-outline-primary">Barra</button>
            <button id="btnAtendentePizza" class="btn btn-sm btn-outline-primary">Pizza</button>
            <button id="btnAtendenteDownload" class="btn btn-sm btn-outline-secondary">Baixar PNG</button>
          </div>
        </div>
        <canvas id="chartAtendente"></canvas>
        <div class="small text-muted mt-2" id="totalAtendentes"></div>
      </div>
    </div>
  </div>

  <!-- Exportar Dados -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Exportar Relatórios</h6>
        <p class="text-muted small">Exporte os dados filtrados em diferentes formatos</p>
        
        <div class="row g-2">
          <div class="col-6">
            <h6 class="small">Resumido</h6>
            <button id="btnExportCSVResumo" class="btn btn-sm btn-outline-success w-100 mb-1">CSV Resumo</button>
            <button id="btnExportPDFResumo" class="btn btn-sm btn-outline-danger w-100">PDF Resumo</button>
          </div>
          <div class="col-6">
            <h6 class="small">Detalhado</h6>
            <button id="btnExportCSVDetalhado" class="btn btn-sm btn-outline-success w-100 mb-1">CSV Completo</button>
            <button id="btnExportPDFDetalhado" class="btn btn-sm btn-outline-danger w-100">PDF Completo</button>
          </div>
        </div>
        
        <div class="form-text mt-2">
          Os filtros aplicados serão considerados na exportação.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts: Chart.js + plugin de Zoom -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
<script>
const elStart = document.getElementById('fStart');
const elEnd = document.getElementById('fEnd');
const elTipos = document.getElementById('fTipos');

function getTiposSelecionados() {
  return Array.from(elTipos.selectedOptions).map(o => o.value);
}

function buildQuery() {
  const params = new URLSearchParams();
  if (elStart.value) params.set('start', elStart.value);
  if (elEnd.value) params.set('end', elEnd.value);
  const tipos = getTiposSelecionados();
  if (tipos.length) params.set('tipos', tipos.join(','));
  return params.toString();
}

function pct(value, total) {
  if (!total) return '0%';
  return ((value / total) * 100).toFixed(1) + '%';
}

let chartDuvida, chartDia;

function destroyChart(c) { if (c) { c.destroy(); } }

async function loadDuvida() {
  try {
    const q = buildQuery();
    console.log('Loading duvida chart with params:', q);
    
    const res = await fetch('/api/stats/por_duvida' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading duvida data:', res.status, res.statusText);
      document.getElementById('totalDuvidas').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Duvida data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for duvida:', data);
      document.getElementById('totalDuvidas').innerText = 'Dados em formato inválido';
      return;
    }

    const ctx = document.getElementById('chartDuvida');
    if (!ctx) {
      console.error('Canvas element chartDuvida not found');
      return;
    }
    
    destroyChart(chartDuvida);

    const total = data.total || data.counts.reduce((a,b)=>a+b,0);
    document.getElementById('totalDuvidas').innerText = `Total de ligações no período: ${total}`;

    chartDuvida = new Chart(ctx, {
      type: window._tipoDuvida || 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: 'Quantidade',
          data: data.counts || []
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const val = ctx.raw ?? 0;
                return `${val} (${pct(val, total)})`;
              }
            }
          }
        },
        scales: window._tipoDuvida === 'pie' ? {} : {
          x: { ticks: { autoSkip: false } },
          y: { beginAtZero: true }
        }
      }
    });
    
    console.log('Duvida chart created successfully');
  } catch (error) {
    console.error('Exception in loadDuvida:', error);
    document.getElementById('totalDuvidas').innerText = 'Erro ao carregar gráfico';
  }
}

function movingAverage(arr, w=7) {
  const out = [];
  for (let i=0;i<arr.length;i++) {
    const s = Math.max(0, i-w+1);
    const slice = arr.slice(s, i+1);
    const m = slice.reduce((a,b)=>a+b,0) / slice.length;
    out.push(Number(m.toFixed(2)));
  }
  return out;
}

async function loadDia() {
  try {
    const q = buildQuery();
    console.log('Loading dia chart with params:', q);
    
    const res = await fetch('/api/stats/por_dia' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading dia data:', res.status, res.statusText);
      return;
    }
    
    const data = await res.json();
    console.log('Dia data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for dia:', data);
      return;
    }

    const ctx = document.getElementById('chartDia');
    if (!ctx) {
      console.error('Canvas element chartDia not found');
      return;
    }
    
    destroyChart(chartDia);

    const baseDataset = {
      label: 'Ligações por dia',
      data: data.counts || []
    };
    const datasets = [baseDataset];

    if (document.getElementById('chkMedia').checked) {
      datasets.push({
        label: 'Média móvel 7d',
        data: movingAverage(data.counts || [], 7),
        borderWidth: 2,
        tension: 0.2
      });
    }

    chartDia = new Chart(ctx, {
      type: 'line',
      data: { labels: data.labels || [], datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          zoom: {
            zoom: {
              wheel: { enabled: true },
              drag: { enabled: true },
              mode: 'x'
            },
            pan: {
              enabled: true,
              mode: 'x',
              modifierKey: 'alt'
            }
          }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
    
    console.log('Dia chart created successfully');
  } catch (error) {
    console.error('Exception in loadDia:', error);
  }
}

// Novos relatórios
async function loadComparativo() {
  try {
    const q = buildQuery();
    const periodo = document.getElementById('selPeriodo').value;
    const params = new URLSearchParams(q);
    params.set('periodo', periodo);
    
    console.log('Loading comparativo chart with params:', params.toString());
    
    const res = await fetch('/api/stats/comparativo_periodo?' + params.toString());
    
    if (!res.ok) {
      console.error('Error loading comparativo data:', res.status, res.statusText);
      document.getElementById('totalComparativo').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Comparativo data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for comparativo:', data);
      document.getElementById('totalComparativo').innerText = 'Dados em formato inválido';
      return;
    }

    const ctx = document.getElementById('chartComparativo');
    if (!ctx) {
      console.error('Canvas element chartComparativo not found');
      return;
    }
    
    destroyChart(window.chartComparativo);

    const total = data.total || 0;
    document.getElementById('totalComparativo').innerText = `Total no período (${data.periodo || periodo}): ${total}`;

    window.chartComparativo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: `Ligações por ${data.periodo || periodo}`,
          data: data.counts || [],
          backgroundColor: 'rgba(54, 162, 235, 0.8)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 15 } },
          y: { beginAtZero: true }
        }
      }
    });
    
    console.log('Comparativo chart created successfully');
  } catch (error) {
    console.error('Exception in loadComparativo:', error);
    document.getElementById('totalComparativo').innerText = 'Erro ao carregar gráfico';
  }
}

async function loadHorarios() {
  try {
    const q = buildQuery();
    console.log('Loading horarios chart with params:', q);
    
    const res = await fetch('/api/stats/pico_horarios' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading horarios data:', res.status, res.statusText);
      document.getElementById('totalHorarios').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Horarios data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for horarios:', data);
      document.getElementById('totalHorarios').innerText = 'Dados em formato inválido';
      return;
    }

    const ctx = document.getElementById('chartHorario');
    if (!ctx) {
      console.error('Canvas element chartHorario not found');
      return;
    }
    
    destroyChart(window.chartHorario);

    const total = data.total || 0;
    const maxIndex = data.counts.length > 0 ? data.counts.indexOf(Math.max(...data.counts)) : -1;
    const maxHour = maxIndex >= 0 ? data.labels[maxIndex] : 'N/A';
    const maxValue = maxIndex >= 0 ? Math.max(...data.counts) : 0;
    document.getElementById('totalHorarios').innerText = `Total: ${total} | Pico: ${maxHour} (${maxValue} ligações)`;

    window.chartHorario = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: 'Ligações por hora',
          data: data.counts || [],
          backgroundColor: 'rgba(255, 159, 64, 0.8)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { ticks: { autoSkip: false } },
          y: { beginAtZero: true }
        }
      }
    });
    
    console.log('Horarios chart created successfully');
  } catch (error) {
    console.error('Exception in loadHorarios:', error);
    document.getElementById('totalHorarios').innerText = 'Erro ao carregar gráfico';
  }
}

async function loadAtendentes() {
  try {
    const q = buildQuery();
    console.log('Loading atendentes chart with params:', q);
    
    const res = await fetch('/api/stats/por_atendente' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading atendentes data:', res.status, res.statusText);
      document.getElementById('totalAtendentes').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Atendentes data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for atendentes:', data);
      document.getElementById('totalAtendentes').innerText = 'Dados em formato inválido';
      return;
    }

    const ctx = document.getElementById('chartAtendente');
    if (!ctx) {
      console.error('Canvas element chartAtendente not found');
      return;
    }
    
    destroyChart(window.chartAtendente);

    const total = data.total || 0;
    document.getElementById('totalAtendentes').innerText = `Total de ligações: ${total}`;

    window.chartAtendente = new Chart(ctx, {
      type: window._tipoAtendente || 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: 'Ligações',
          data: data.counts || [],
          backgroundColor: 'rgba(75, 192, 192, 0.8)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const val = ctx.raw ?? 0;
                return `${val} (${pct(val, total)})`;
              }
            }
          }
        },
        scales: window._tipoAtendente === 'pie' ? {} : {
          x: { ticks: { autoSkip: false } },
          y: { beginAtZero: true }
        }
      }
    });
    
    console.log('Atendentes chart created successfully');
  } catch (error) {
    console.error('Exception in loadAtendentes:', error);
    document.getElementById('totalAtendentes').innerText = 'Erro ao carregar gráfico';
  }
}

function exportData(type, format) {
  const q = buildQuery();
  const params = new URLSearchParams(q);
  params.set('tipo', type);
  
  const url = `/api/export/${format}?` + params.toString();
  window.open(url, '_blank');
}

/* Botões e eventos */
document.getElementById('btnAplicar').addEventListener('click', () => {
  loadDuvida(); loadDia(); loadComparativo(); loadHorarios(); loadAtendentes();
});
document.getElementById('btnLimpar').addEventListener('click', () => {
  elStart.value = ''; elEnd.value = '';
  Array.from(elTipos.options).forEach(o=>o.selected=false);
  loadDuvida(); loadDia(); loadComparativo(); loadHorarios(); loadAtendentes();
});

document.getElementById('btnTipoBar').addEventListener('click', () => {
  window._tipoDuvida = 'bar';
  loadDuvida();
});
document.getElementById('btnTipoPie').addEventListener('click', () => {
  window._tipoDuvida = 'pie';
  loadDuvida();
});

document.getElementById('chkMedia').addEventListener('change', () => {
  loadDia();
});

document.getElementById('btnZoomReset').addEventListener('click', () => {
  if (chartDia) chartDia.resetZoom();
});

document.getElementById('btnTipoDownload').addEventListener('click', () => {
  if (!chartDuvida) return;
  const url = chartDuvida.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'por_tipo.png'; a.click();
});

document.getElementById('btnDiaDownload').addEventListener('click', () => {
  if (!chartDia) return;
  const url = chartDia.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'por_dia.png'; a.click();
});

/* Carrega inicial */
loadDuvida(); loadDia(); loadComparativo(); loadHorarios(); loadAtendentes();

// Event listeners para novos controles
document.getElementById('selPeriodo').addEventListener('change', () => {
  loadComparativo();
});

// Atendente chart type toggles
document.getElementById('btnAtendenteBarra').addEventListener('click', () => {
  window._tipoAtendente = 'bar';
  loadAtendentes();
});
document.getElementById('btnAtendentePizza').addEventListener('click', () => {
  window._tipoAtendente = 'pie';
  loadAtendentes();
});

// Download buttons for new charts
document.getElementById('btnComparativoDownload').addEventListener('click', () => {
  if (!window.chartComparativo) return;
  const url = window.chartComparativo.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'comparativo_periodo.png'; a.click();
});

document.getElementById('btnHorarioDownload').addEventListener('click', () => {
  if (!window.chartHorario) return;
  const url = window.chartHorario.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'pico_horarios.png'; a.click();
});

document.getElementById('btnAtendenteDownload').addEventListener('click', () => {
  if (!window.chartAtendente) return;
  const url = window.chartAtendente.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'por_atendente.png'; a.click();
});

// Export buttons
document.getElementById('btnExportCSVResumo').addEventListener('click', () => {
  exportData('por_duvida', 'csv');
});

document.getElementById('btnExportPDFResumo').addEventListener('click', () => {
  exportData('por_duvida', 'pdf');
});

document.getElementById('btnExportCSVDetalhado').addEventListener('click', () => {
  exportData('detalhado', 'csv');
});

document.getElementById('btnExportPDFDetalhado').addEventListener('click', () => {
  exportData('detalhado', 'pdf');
});
</script>
{% endblock %}
