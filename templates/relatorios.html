{% extends "base.html" %}
{% block content %}

<!-- Cabeçalho específico para impressão (aparece no PDF) -->
<div class="only-print mb-3">
  <div class="d-flex align-items-center gap-3">
    <img src="/static/logo-crors.png" alt="CRO/RS" class="print-logo" onerror="this.style.display='none'">
    <div>
      <h5 class="mb-0">ELEIÇÕES CRORS - 2025</h5>
      <small>Relatórios de ligações</small>
    </div>
  </div>
  <hr>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="m-0">Relatórios e Gráficos</h4>
  <div class="no-print d-flex gap-2">
    <button class="btn btn-outline-secondary" onclick="window.print()">Imprimir / Salvar PDF</button>
    <a class="btn btn-outline-primary" href="/">Voltar ao cadastro</a>
  </div>
</div>

<!-- KPI Cards Dashboard -->
<div class="row g-4 mb-4 no-print" id="kpiCards">
  <div class="col-md-3">
    <div class="card bg-gradient-primary text-white border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center mb-2">
          <i class="fas fa-phone fa-2x opacity-75"></i>
        </div>
        <h2 class="fw-bold mb-1" id="kpiTotalLigacoes">-</h2>
        <p class="mb-0 opacity-90">Total de Ligações</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-gradient-success text-white border-0" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center mb-2">
          <i class="fas fa-chart-line fa-2x opacity-75"></i>
        </div>
        <h2 class="fw-bold mb-1" id="kpiMediaDiaria">-</h2>
        <p class="mb-0 opacity-90">Média Diária</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-gradient-warning text-white border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center mb-2">
          <i class="fas fa-clock fa-2x opacity-75"></i>
        </div>
        <h2 class="fw-bold mb-1" id="kpiPicoHorario">-</h2>
        <p class="mb-0 opacity-90">Pico Horário</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-gradient-info text-white border-0" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center mb-2">
          <i class="fas fa-users fa-2x opacity-75"></i>
        </div>
        <h2 class="fw-bold mb-1" id="kpiAtendentesAtivos">-</h2>
        <p class="mb-0 opacity-90">Atendentes Ativos</p>
      </div>
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="card shadow-lg mb-4 no-print" style="border-radius: 16px; border: 1px solid rgba(0,0,0,0.05);">
  <div class="card-body">
    <div class="d-flex align-items-center mb-3">
      <i class="fas fa-filter text-primary me-2"></i>
      <h5 class="mb-0 text-primary">Filtros de Dados</h5>
    </div>
    <form class="row g-3 align-items-end">
      <div class="col-sm-3">
        <label class="form-label fw-semibold">Início</label>
        <input type="date" id="fStart" class="form-control" style="border-radius: 10px;">
      </div>
      <div class="col-sm-3">
        <label class="form-label fw-semibold">Fim</label>
        <input type="date" id="fEnd" class="form-control" style="border-radius: 10px;">
      </div>
      <div class="col-sm-4">
        <label class="form-label fw-semibold">Tipo de Dúvida (multi)</label>
        <select id="fTipos" class="form-select" multiple size="4" style="border-radius: 10px;">
          {% for opt in duvida_opcoes %}
          <option value="{{ opt }}">{{ opt }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Segure CTRL (ou CMD) para selecionar múltiplos.</div>
      </div>
      <div class="col-sm-2 d-flex gap-2">
        <button type="button" id="btnAplicar" class="btn btn-primary w-100" style="border-radius: 10px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
          <i class="fas fa-search me-1"></i>Aplicar
        </button>
        <button type="button" id="btnLimpar" class="btn btn-outline-secondary" style="border-radius: 10px;">
          <i class="fas fa-eraser me-1"></i>Limpar
        </button>
      </div>
    </form>
  </div>
</div>

<div class="row g-4">
  <!-- Por Tipo -->
  <div class="col-lg-6">
    <div class="card border-0" style="border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center">
            <div class="p-2 me-2 rounded-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <i class="fas fa-chart-pie text-white"></i>
            </div>
            <h5 class="card-title m-0 fw-bold text-dark">Distribuição por Tipo de Dúvida</h5>
          </div>
          <div class="no-print d-flex gap-2">
            <button id="btnTipoBar" class="btn btn-sm btn-outline-primary" style="border-radius: 8px; border-width: 2px;">
              <i class="fas fa-chart-bar me-1"></i>Barra
            </button>
            <button id="btnTipoPie" class="btn btn-sm btn-outline-primary" style="border-radius: 8px; border-width: 2px;">
              <i class="fas fa-chart-pie me-1"></i>Pizza
            </button>
            <button id="btnTipoDownload" class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px;">
              <i class="fas fa-download me-1"></i>PNG
            </button>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 350px; max-height: 400px;">
          <canvas id="chartDuvida" style="border-radius: 12px;"></canvas>
        </div>
        <div class="small text-muted mt-3 p-2 bg-light rounded-3" id="totalDuvidas"></div>
      </div>
    </div>
  </div>

  <!-- Por Dia -->
  <div class="col-lg-6">
    <div class="card border-0" style="border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center">
            <div class="p-2 me-2 rounded-3" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
              <i class="fas fa-chart-line text-white"></i>
            </div>
            <h5 class="card-title m-0 fw-bold text-dark">Ligações por Dia (BR/RS)</h5>
          </div>
          <div class="no-print d-flex flex-wrap gap-2">
            <div class="form-check me-2">
              <input class="form-check-input" type="checkbox" id="chkMedia">
              <label class="form-check-label fw-medium" for="chkMedia">Média móvel 7d</label>
            </div>
            <button id="btnZoomReset" class="btn btn-sm btn-outline-success" style="border-radius: 8px; border-width: 2px;">
              <i class="fas fa-search-minus me-1"></i>Reset
            </button>
            <button id="btnDiaDownload" class="btn btn-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px;">
              <i class="fas fa-download me-1"></i>PNG
            </button>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 350px; max-height: 400px;">
          <canvas id="chartDia" style="border-radius: 12px;"></canvas>
        </div>
        <div class="form-text mt-3 p-2 bg-light rounded-3">
          <i class="fas fa-info-circle text-primary me-1"></i>
          Arraste para <strong>zoom</strong> (horizontal). Use a roda do mouse para zoom. Segure <strong>Alt</strong> para pan.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Novos relatórios -->
<div class="row g-4 mt-2">
  <!-- Comparativo por Período -->
  <div class="col-lg-6">
    <div class="card border-0" style="border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center">
            <div class="p-2 me-2 rounded-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
              <i class="fas fa-chart-area text-white"></i>
            </div>
            <h5 class="card-title m-0 fw-bold text-dark">Comparativo por Período</h5>
          </div>
          <div class="no-print d-flex gap-2">
            <select id="selPeriodo" class="form-select form-select-sm" style="width: auto; border-radius: 8px; border-width: 2px;">
              <option value="dia">Por Dia</option>
              <option value="semana">Por Semana</option>
              <option value="mes">Por Mês</option>
              <option value="ano">Por Ano</option>
            </select>
            <button id="btnComparativoDownload" class="btn btn-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px;">
              <i class="fas fa-download me-1"></i>PNG
            </button>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 280px; max-height: 320px;">
          <canvas id="chartComparativo" style="border-radius: 12px;"></canvas>
        </div>
        <div class="small text-muted mt-3 p-2 bg-light rounded-3" id="totalComparativo"></div>
      </div>
    </div>
  </div>

  <!-- Pico de Horários -->
  <div class="col-lg-6">
    <div class="card border-0" style="border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center">
            <div class="p-2 me-2 rounded-3" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
              <i class="fas fa-clock text-white"></i>
            </div>
            <h5 class="card-title m-0 fw-bold text-dark">Pico de Horários</h5>
          </div>
          <div class="no-print d-flex gap-2">
            <button id="btnHorarioDownload" class="btn btn-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px;">
              <i class="fas fa-download me-1"></i>PNG
            </button>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 280px; max-height: 320px;">
          <canvas id="chartHorario" style="border-radius: 12px;"></canvas>
        </div>
        <div class="small text-muted mt-3 p-2 bg-light rounded-3" id="totalHorarios"></div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-2">
  <!-- Por Atendente -->
  <div class="col-lg-6">
    <div class="card border-0" style="border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center">
            <div class="p-2 me-2 rounded-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <i class="fas fa-users text-white"></i>
            </div>
            <h5 class="card-title m-0 fw-bold text-dark">Ligações por Atendente</h5>
          </div>
          <div class="no-print d-flex gap-2">
            <button id="btnAtendenteBarra" class="btn btn-sm btn-outline-primary" style="border-radius: 8px; border-width: 2px;">
              <i class="fas fa-chart-bar me-1"></i>Barra
            </button>
            <button id="btnAtendentePizza" class="btn btn-sm btn-outline-primary" style="border-radius: 8px; border-width: 2px;">
              <i class="fas fa-chart-pie me-1"></i>Pizza
            </button>
            <button id="btnAtendenteDownload" class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px;">
              <i class="fas fa-download me-1"></i>PNG
            </button>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 350px; max-height: 400px;">
          <canvas id="chartAtendente" style="border-radius: 12px;"></canvas>
        </div>
        <div class="small text-muted mt-3 p-2 bg-light rounded-3" id="totalAtendentes"></div>
      </div>
    </div>
  </div>

  <!-- Exportar Dados -->
  <div class="col-lg-6">
    <div class="card border-0" style="border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
      <div class="card-body p-4">
        <div class="d-flex align-items-center mb-3">
          <div class="p-2 me-2 rounded-3" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <i class="fas fa-file-export text-white"></i>
          </div>
          <h5 class="card-title m-0 fw-bold text-dark">Exportar Relatórios</h5>
        </div>
        <p class="text-muted mb-4">Exporte os dados filtrados em diferentes formatos</p>
        
        <div class="row g-3">
          <div class="col-6">
            <div class="bg-light p-3 rounded-3">
              <h6 class="fw-bold text-dark mb-3">
                <i class="fas fa-file-alt text-success me-2"></i>Resumido
              </h6>
              <button id="btnExportCSVResumo" class="btn btn-success w-100 mb-2" style="border-radius: 10px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);">
                <i class="fas fa-file-csv me-1"></i>CSV Resumo
              </button>
              <button id="btnExportPDFResumo" class="btn btn-outline-danger w-100" style="border-radius: 10px; border-width: 2px;">
                <i class="fas fa-file-pdf me-1"></i>PDF Resumo
              </button>
            </div>
          </div>
          <div class="col-6">
            <div class="bg-light p-3 rounded-3">
              <h6 class="fw-bold text-dark mb-3">
                <i class="fas fa-database text-info me-2"></i>Detalhado
              </h6>
              <button id="btnExportCSVDetalhado" class="btn btn-success w-100 mb-2" style="border-radius: 10px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);">
                <i class="fas fa-file-csv me-1"></i>CSV Completo
              </button>
              <button id="btnExportPDFDetalhado" class="btn btn-outline-danger w-100" style="border-radius: 10px; border-width: 2px;">
                <i class="fas fa-file-pdf me-1"></i>PDF Completo
              </button>
            </div>
          </div>
        </div>
        
        <div class="alert alert-info mt-4" style="border: none; background: linear-gradient(135deg, rgba(75, 192, 192, 0.1) 0%, rgba(54, 162, 235, 0.1) 100%); border-radius: 10px;">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Nota:</strong> Os filtros aplicados serão considerados na exportação.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts: Chart.js + plugin de Zoom (using alternative CDNs) -->
<script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js" onload="console.log('Chart.js loaded successfully from unpkg')" onerror="loadChartJSFallback()"></script>
<script src="https://unpkg.com/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js" onload="console.log('Chart.js zoom plugin loaded successfully')" onerror="console.warn('Chart.js zoom plugin failed to load')"></script>

<script>
function loadChartJSFallback() {
  console.warn('Chart.js failed to load from unpkg, trying jsdelivr...');
  const script1 = document.createElement('script');
  script1.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.min.js';
  script1.onload = () => console.log('Chart.js loaded successfully from jsdelivr fallback');
  script1.onerror = () => {
    console.error('All Chart.js CDNs failed. Charts will not work.');
    // Show error message on page
    document.querySelectorAll('canvas').forEach(canvas => {
      const container = canvas.parentElement;
      if (container) {
        container.innerHTML = '<div class="alert alert-warning">Chart.js library failed to load from CDN. Charts cannot be displayed.</div>';
      }
    });
  };
  document.head.appendChild(script1);

  const script2 = document.createElement('script');
  script2.src = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js';
  document.head.appendChild(script2);
}

// Check if Chart.js is loaded after a short delay
setTimeout(() => {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js is still not defined after loading attempts');
    document.querySelectorAll('canvas').forEach(canvas => {
      const container = canvas.parentElement;
      if (container) {
        container.innerHTML = '<div class="alert alert-warning">Chart.js library failed to load. Please refresh the page or check your internet connection.</div>';
      }
    });
  } else {
    console.log('Chart.js is available and ready');
  }
}, 2000);
</script>
<script>
// Modern color palette for charts
const chartColors = {
  primary: ['#667eea', '#764ba2', '#4facfe', '#00f2fe'],
  gradient: {
    purple: ['#667eea', '#764ba2'],
    blue: ['#4facfe', '#00f2fe'],
    green: ['#11998e', '#38ef7d'],
    pink: ['#f093fb', '#f5576c'],
    orange: ['#ffecd2', '#fcb69f']
  },
  rainbow: [
    '#667eea', '#764ba2', '#4facfe', '#00f2fe',
    '#11998e', '#38ef7d', '#f093fb', '#f5576c',
    '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
  ]
};

// Function to create gradient background
function createGradient(ctx, colors, direction = 'vertical') {
  // Handle canvas context or chart context
  const canvas = ctx.canvas || ctx;
  const context = ctx.getContext ? ctx.getContext('2d') : ctx;
  
  const gradient = direction === 'vertical' 
    ? context.createLinearGradient(0, 0, 0, canvas.height || 400)
    : context.createLinearGradient(0, 0, canvas.width || 400, 0);
  
  gradient.addColorStop(0, colors[0]);
  gradient.addColorStop(1, colors[1]);
  return gradient;
}

// Enhanced Chart.js default configuration
Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
Chart.defaults.font.size = 13;
Chart.defaults.color = '#374151';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.boxWidth = 8;
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(255, 255, 255, 0.95)';
Chart.defaults.plugins.tooltip.titleColor = '#1f2937';
Chart.defaults.plugins.tooltip.bodyColor = '#4b5563';
Chart.defaults.plugins.tooltip.borderColor = '#e5e7eb';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.cornerRadius = 10;
Chart.defaults.plugins.tooltip.displayColors = true;
Chart.defaults.plugins.tooltip.padding = 12;

// Animation configuration
const chartAnimation = {
  duration: 1200,
  easing: 'easeOutQuart',
  delay: (context) => context.dataIndex * 100
};

// Global KPI data store to persist values across function calls
window.kpiData = {
  total: '0',
  mediaDiaria: '0',
  picoHorario: '--:--',
  atendentesAtivos: '0'
};

// Function to update KPI cards
function updateKPICards(data) {
  // Update global KPI data with provided values only
  if (data.total !== undefined) window.kpiData.total = data.total.toLocaleString ? data.total.toLocaleString('pt-BR') : data.total.toString();
  if (data.mediaDiaria !== undefined) window.kpiData.mediaDiaria = data.mediaDiaria;
  if (data.picoHorario !== undefined) window.kpiData.picoHorario = data.picoHorario;
  if (data.atendentesAtivos !== undefined) window.kpiData.atendentesAtivos = data.atendentesAtivos;

  // Get elements and update with current values
  const kpiElements = {
    total: document.getElementById('kpiTotalLigacoes'),
    media: document.getElementById('kpiMediaDiaria'),
    pico: document.getElementById('kpiPicoHorario'),
    atendentes: document.getElementById('kpiAtendentesAtivos')
  };

  // Update display with current data
  if (kpiElements.total) kpiElements.total.textContent = window.kpiData.total;
  if (kpiElements.media) kpiElements.media.textContent = window.kpiData.mediaDiaria;
  if (kpiElements.pico) kpiElements.pico.textContent = window.kpiData.picoHorario;
  if (kpiElements.atendentes) kpiElements.atendentes.textContent = window.kpiData.atendentesAtivos;
}

const elStart = document.getElementById('fStart');
const elEnd = document.getElementById('fEnd');
const elTipos = document.getElementById('fTipos');

function getTiposSelecionados() {
  return Array.from(elTipos.selectedOptions).map(o => o.value);
}

function buildQuery() {
  const params = new URLSearchParams();
  if (elStart.value) params.set('start', elStart.value);
  if (elEnd.value) params.set('end', elEnd.value);
  const tipos = getTiposSelecionados();
  if (tipos.length) params.set('tipos', tipos.join(','));
  return params.toString();
}

function pct(value, total) {
  if (!total) return '0%';
  return ((value / total) * 100).toFixed(1) + '%';
}

let chartDuvida, chartDia;

function destroyChart(c) { 
  if (c && typeof c.destroy === 'function') { 
    c.destroy(); 
  } 
}

function showDataAsTable(canvasId, data, title) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const container = canvas.parentElement;
  if (!container) return;
  
  // Replace canvas with table
  let html = `<div class="chart-fallback">
    <div class="alert alert-info mb-2">
      <small>📊 Chart.js não disponível - mostrando dados em tabela</small>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-striped">
        <thead class="table-dark">
          <tr><th>Item</th><th>Quantidade</th></tr>
        </thead>
        <tbody>`;
  
  for (let i = 0; i < data.labels.length; i++) {
    const label = data.labels[i] || 'N/A';
    const count = data.counts[i] || 0;
    html += `<tr><td>${label}</td><td><strong>${count}</strong></td></tr>`;
  }
  
  html += `</tbody></table></div></div>`;
  container.innerHTML = html;
}

async function loadDuvida() {
  try {
    if (typeof Chart === 'undefined') {
      console.error('Chart.js is not loaded - cannot create duvida chart');
      document.getElementById('totalDuvidas').innerText = 'Chart.js não carregado - recarregue a página';
      return;
    }
    
    const q = buildQuery();
    console.log('Loading duvida chart with params:', q);
    
    const res = await fetch('/api/stats/por_duvida' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading duvida data:', res.status, res.statusText);
      document.getElementById('totalDuvidas').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Duvida data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for duvida:', data);
      document.getElementById('totalDuvidas').innerText = 'Dados em formato inválido';
      return;
    }

    const ctx = document.getElementById('chartDuvida');
    if (!ctx) {
      console.error('Canvas element chartDuvida not found');
      return;
    }
    
    destroyChart(chartDuvida);

    const total = data.total || data.counts.reduce((a,b)=>a+b,0);
    document.getElementById('totalDuvidas').innerHTML = `
      <i class="fas fa-chart-pie text-primary me-2"></i>
      <strong>Total de ligações:</strong> ${total.toLocaleString('pt-BR')}
    `;

    // Create gradients for backgrounds
    const backgroundColors = window._tipoDuvida === 'pie' 
      ? chartColors.rainbow.slice(0, data.labels.length)
      : chartColors.rainbow.slice(0, data.labels.length).map(color => color + '80'); // 50% opacity

    chartDuvida = new Chart(ctx, {
      type: window._tipoDuvida || 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: 'Quantidade',
          data: data.counts || [],
          backgroundColor: backgroundColors,
          borderColor: chartColors.gradient.purple[0],
          borderWidth: window._tipoDuvida === 'pie' ? 0 : 2,
          borderRadius: window._tipoDuvida === 'pie' ? 0 : 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: chartAnimation,
        plugins: {
          legend: { 
            display: window._tipoDuvida === 'pie',
            position: 'bottom',
            labels: {
              padding: 20,
              font: { weight: '500' }
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const val = ctx.raw ?? 0;
                const percentage = pct(val, total);
                return `${ctx.label}: ${val.toLocaleString('pt-BR')} (${percentage})`;
              }
            }
          }
        },
        scales: window._tipoDuvida === 'pie' ? {} : {
          x: { 
            ticks: { 
              autoSkip: false,
              font: { weight: '500' }
            },
            grid: { display: false }
          },
          y: { 
            beginAtZero: true,
            ticks: {
              font: { weight: '500' },
              callback: function(value) {
                return value.toLocaleString('pt-BR');
              }
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });

    // Update KPI cards
    updateKPICards({ total: total });
    
    console.log('Duvida chart created successfully');
  } catch (error) {
    console.error('Exception in loadDuvida:', error);
    document.getElementById('totalDuvidas').innerText = 'Erro ao carregar gráfico';
  }
}

function movingAverage(arr, w=7) {
  const out = [];
  for (let i=0;i<arr.length;i++) {
    const s = Math.max(0, i-w+1);
    const slice = arr.slice(s, i+1);
    const m = slice.reduce((a,b)=>a+b,0) / slice.length;
    out.push(Number(m.toFixed(2)));
  }
  return out;
}

async function loadDia() {
  try {
    if (typeof Chart === 'undefined') {
      console.error('Chart.js is not loaded - cannot create dia chart');
      return;
    }
    
    const q = buildQuery();
    console.log('Loading dia chart with params:', q);
    
    const res = await fetch('/api/stats/por_dia' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading dia data:', res.status, res.statusText);
      return;
    }
    
    const data = await res.json();
    console.log('Dia data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for dia:', data);
      return;
    }

    const ctx = document.getElementById('chartDia');
    if (!ctx) {
      console.error('Canvas element chartDia not found');
      return;
    }
    
    destroyChart(chartDia);

    const baseDataset = {
      label: 'Ligações por dia',
      data: data.counts || [],
      borderColor: chartColors.gradient.green[0],
      backgroundColor: chartColors.gradient.green[0] + '20', // 12.5% opacity
      borderWidth: 3,
      fill: true,
      tension: 0.4,
      pointBackgroundColor: chartColors.gradient.green[0],
      pointBorderColor: '#ffffff',
      pointBorderWidth: 2,
      pointRadius: 5,
      pointHoverRadius: 7
    };
    const datasets = [baseDataset];

    if (document.getElementById('chkMedia').checked) {
      datasets.push({
        label: 'Média móvel 7d',
        data: movingAverage(data.counts || [], 7),
        borderColor: chartColors.gradient.pink[0],
        backgroundColor: 'rgba(240, 147, 251, 0.1)',
        borderWidth: 2,
        tension: 0.2,
        pointRadius: 3,
        pointHoverRadius: 5,
        fill: false,
        borderDash: [5, 5]
      });
    }

    const total = data.counts.reduce((a, b) => a + b, 0);
    const media = total / data.counts.length || 0;

    chartDia = new Chart(ctx, {
      type: 'line',
      data: { labels: data.labels || [], datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 1500,
          easing: 'easeOutQuart'
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: { 
            display: true,
            position: 'top',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { weight: '500' }
            }
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                return `Data: ${context[0].label}`;
              },
              label: function(context) {
                return `${context.dataset.label}: ${context.raw.toLocaleString('pt-BR')}`;
              }
            }
          },
          zoom: {
            zoom: {
              wheel: { enabled: true },
              drag: { enabled: true },
              mode: 'x'
            },
            pan: {
              enabled: true,
              mode: 'x',
              modifierKey: 'alt'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              font: { weight: '500' }
            },
            grid: { display: false }
          },
          y: { 
            beginAtZero: true,
            ticks: {
              font: { weight: '500' },
              callback: function(value) {
                return value.toLocaleString('pt-BR');
              }
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });

    // Update KPI cards with daily data
    updateKPICards({ 
      mediaDiaria: Math.round(media).toLocaleString('pt-BR')
    });
    
    console.log('Dia chart created successfully');
  } catch (error) {
    console.error('Exception in loadDia:', error);
  }
}

// Novos relatórios
async function loadComparativo() {
  try {
    const q = buildQuery();
    const periodo = document.getElementById('selPeriodo').value;
    const params = new URLSearchParams(q);
    params.set('periodo', periodo);
    
    console.log('Loading comparativo chart with params:', params.toString());
    
    const res = await fetch('/api/stats/comparativo_periodo?' + params.toString());
    
    if (!res.ok) {
      console.error('Error loading comparativo data:', res.status, res.statusText);
      document.getElementById('totalComparativo').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Comparativo data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for comparativo:', data);
      document.getElementById('totalComparativo').innerText = 'Dados em formato inválido';
      return;
    }

    const total = data.total || 0;
    document.getElementById('totalComparativo').innerHTML = `
      <i class="fas fa-chart-area text-danger me-2"></i>
      <strong>Total no período (${data.periodo || periodo}):</strong> ${total.toLocaleString('pt-BR')}
    `;

    if (typeof Chart === 'undefined') {
      console.warn('Chart.js is not loaded - showing data as table for comparativo chart');
      showDataAsTable('chartComparativo', data, `Ligações por ${data.periodo || periodo}`);
      return;
    }

    const ctx = document.getElementById('chartComparativo');
    if (!ctx) {
      console.error('Canvas element chartComparativo not found');
      return;
    }
    
    destroyChart(window.chartComparativo);

    // Create gradient backgrounds for each bar
    const backgroundColors = data.counts.map((value, index) => {
      return chartColors.gradient.pink[0] + '80'; // 50% opacity
    });

    window.chartComparativo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: `Ligações por ${data.periodo || periodo}`,
          data: data.counts || [],
          backgroundColor: backgroundColors,
          borderColor: chartColors.gradient.pink[0],
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: chartAnimation,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: function(context) {
                return `${data.periodo || periodo}: ${context[0].label}`;
              },
              label: function(context) {
                return `Ligações: ${context.raw.toLocaleString('pt-BR')}`;
              }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              autoSkip: true, 
              maxTicksLimit: 15,
              font: { weight: '500' }
            },
            grid: { display: false }
          },
          y: { 
            beginAtZero: true,
            ticks: {
              font: { weight: '500' },
              callback: function(value) {
                return value.toLocaleString('pt-BR');
              }
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });
    
    console.log('Comparativo chart created successfully');
  } catch (error) {
    console.error('Exception in loadComparativo:', error);
    document.getElementById('totalComparativo').innerText = 'Erro ao carregar gráfico';
  }
}

async function loadHorarios() {
  try {
    const q = buildQuery();
    console.log('Loading horarios chart with params:', q);
    
    const res = await fetch('/api/stats/pico_horarios' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading horarios data:', res.status, res.statusText);
      document.getElementById('totalHorarios').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Horarios data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for horarios:', data);
      document.getElementById('totalHorarios').innerText = 'Dados em formato inválido';
      return;
    }

    const total = data.total || 0;
    const maxIndex = data.counts.length > 0 ? data.counts.indexOf(Math.max(...data.counts)) : -1;
    const maxHour = maxIndex >= 0 ? data.labels[maxIndex] : 'N/A';
    const maxValue = maxIndex >= 0 ? Math.max(...data.counts) : 0;
    document.getElementById('totalHorarios').innerHTML = `
      <i class="fas fa-clock text-info me-2"></i>
      <strong>Total:</strong> ${total.toLocaleString('pt-BR')} | 
      <strong>Pico:</strong> ${maxHour} (${maxValue.toLocaleString('pt-BR')} ligações)
    `;

    if (typeof Chart === 'undefined') {
      console.warn('Chart.js is not loaded - showing data as table for horarios chart');
      // Filter out hours with 0 calls for cleaner display
      const filteredData = {
        labels: data.labels.filter((_, i) => data.counts[i] > 0),
        counts: data.counts.filter(count => count > 0)
      };
      showDataAsTable('chartHorario', filteredData, 'Ligações por hora');
      return;
    }

    const ctx = document.getElementById('chartHorario');
    if (!ctx) {
      console.error('Canvas element chartHorario not found');
      return;
    }
    
    destroyChart(window.chartHorario);

    // Create gradient backgrounds for each bar
    const backgroundColors = data.counts.map((value, index) => {
      const intensity = value / Math.max(...data.counts);
      return value === maxValue 
        ? chartColors.gradient.pink[0] + '80'  // Peak hour - more intense
        : chartColors.gradient.blue[0] + Math.floor(20 + intensity * 60).toString(16); // Variable intensity
    });

    window.chartHorario = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: 'Ligações por hora',
          data: data.counts || [],
          backgroundColor: backgroundColors,
          borderColor: chartColors.gradient.blue[0],
          borderWidth: 2,
          borderRadius: 6,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: chartAnimation,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: function(context) {
                return `Horário: ${context[0].label}`;
              },
              label: function(context) {
                return `Ligações: ${context.raw.toLocaleString('pt-BR')}`;
              }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              autoSkip: false,
              font: { weight: '500' }
            },
            grid: { display: false }
          },
          y: { 
            beginAtZero: true,
            ticks: {
              font: { weight: '500' },
              callback: function(value) {
                return value.toLocaleString('pt-BR');
              }
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });

    // Update KPI with peak hour info
    updateKPICards({ 
      picoHorario: maxHour
    });
    
    console.log('Horarios chart created successfully');
  } catch (error) {
    console.error('Exception in loadHorarios:', error);
    document.getElementById('totalHorarios').innerText = 'Erro ao carregar gráfico';
  }
}

async function loadAtendentes() {
  try {
    const q = buildQuery();
    console.log('Loading atendentes chart with params:', q);
    
    const res = await fetch('/api/stats/por_atendente' + (q ? '?' + q : ''));
    
    if (!res.ok) {
      console.error('Error loading atendentes data:', res.status, res.statusText);
      document.getElementById('totalAtendentes').innerText = `Erro ao carregar dados: ${res.status}`;
      return;
    }
    
    const data = await res.json();
    console.log('Atendentes data received:', data);

    if (!data.labels || !data.counts) {
      console.error('Invalid data format for atendentes:', data);
      document.getElementById('totalAtendentes').innerText = 'Dados em formato inválido';
      return;
    }

    const total = data.total || 0;
    const activeAttendees = data.counts.filter(count => count > 0).length;
    document.getElementById('totalAtendentes').innerHTML = `
      <i class="fas fa-users text-primary me-2"></i>
      <strong>Total de ligações:</strong> ${total.toLocaleString('pt-BR')} | 
      <strong>Atendentes ativos:</strong> ${activeAttendees}
    `;

    if (typeof Chart === 'undefined') {
      console.warn('Chart.js is not loaded - showing data as table for atendentes chart');
      showDataAsTable('chartAtendente', data, 'Ligações por atendente');
      return;
    }

    const ctx = document.getElementById('chartAtendente');
    if (!ctx) {
      console.error('Canvas element chartAtendente not found');
      return;
    }
    
    destroyChart(window.chartAtendente);

    // Create color palette for attendees
    const backgroundColors = window._tipoAtendente === 'pie' 
      ? chartColors.rainbow.slice(0, data.labels.length)
      : chartColors.rainbow.slice(0, data.labels.length).map(color => color + '80'); // 50% opacity

    window.chartAtendente = new Chart(ctx, {
      type: window._tipoAtendente || 'bar',
      data: {
        labels: data.labels || [],
        datasets: [{
          label: 'Ligações',
          data: data.counts || [],
          backgroundColor: backgroundColors,
          borderColor: chartColors.gradient.purple[0],
          borderWidth: window._tipoAtendente === 'pie' ? 0 : 2,
          borderRadius: window._tipoAtendente === 'pie' ? 0 : 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: chartAnimation,
        plugins: {
          legend: { 
            display: window._tipoAtendente === 'pie',
            position: 'bottom',
            labels: {
              padding: 20,
              font: { weight: '500' }
            }
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                return window._tipoAtendente === 'pie' ? context[0].label : `Atendente: ${context[0].label}`;
              },
              label: (ctx) => {
                const val = ctx.raw ?? 0;
                const percentage = pct(val, total);
                return `Ligações: ${val.toLocaleString('pt-BR')} (${percentage})`;
              }
            }
          }
        },
        scales: window._tipoAtendente === 'pie' ? {} : {
          x: { 
            ticks: { 
              autoSkip: false,
              maxRotation: 45,
              font: { weight: '500' }
            },
            grid: { display: false }
          },
          y: { 
            beginAtZero: true,
            ticks: {
              font: { weight: '500' },
              callback: function(value) {
                return value.toLocaleString('pt-BR');
              }
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });

    // Update KPI with active attendees count
    updateKPICards({ 
      atendentesAtivos: activeAttendees.toString()
    });
    
    console.log('Atendentes chart created successfully');
  } catch (error) {
    console.error('Exception in loadAtendentes:', error);
    document.getElementById('totalAtendentes').innerText = 'Erro ao carregar gráfico';
  }
}

function exportData(type, format) {
  const q = buildQuery();
  const params = new URLSearchParams(q);
  params.set('tipo', type);
  
  const url = `/api/export/${format}?` + params.toString();
  window.open(url, '_blank');
}

// Comprehensive KPI update function that aggregates data from all sources
async function updateAllKPIs() {
  try {
    const q = buildQuery();
    
    // Get data from all endpoints simultaneously
    const [duvidaRes, diaRes, horariosRes, atendenteRes] = await Promise.all([
      fetch('/api/stats/por_duvida' + (q ? '?' + q : '')),
      fetch('/api/stats/por_dia' + (q ? '?' + q : '')),
      fetch('/api/stats/pico_horarios' + (q ? '?' + q : '')),
      fetch('/api/stats/por_atendente' + (q ? '?' + q : ''))
    ]);
    
    // Parse all responses
    const [duvidaData, diaData, horariosData, atendenteData] = await Promise.all([
      duvidaRes.ok ? duvidaRes.json() : null,
      diaRes.ok ? diaRes.json() : null,
      horariosRes.ok ? horariosRes.json() : null,
      atendenteRes.ok ? atendenteRes.json() : null
    ]);
    
    // Calculate comprehensive KPI data
    const kpiUpdate = {};
    
    // Total ligações (from duvida or dia data)
    if (duvidaData?.total) {
      kpiUpdate.total = duvidaData.total;
    }
    
    // Média diária (from dia data)
    if (diaData?.counts?.length) {
      const total = diaData.counts.reduce((a, b) => a + b, 0);
      const media = total / diaData.counts.length;
      kpiUpdate.mediaDiaria = Math.round(media).toLocaleString('pt-BR');
    }
    
    // Pico horário (from horarios data)
    if (horariosData?.counts?.length) {
      const maxIndex = horariosData.counts.indexOf(Math.max(...horariosData.counts));
      const maxHour = maxIndex >= 0 ? horariosData.labels[maxIndex] : '--:--';
      const maxValue = maxIndex >= 0 ? Math.max(...horariosData.counts) : 0;
      kpiUpdate.picoHorario = `${maxHour} (${maxValue.toLocaleString('pt-BR')})`;
    }
    
    // Atendentes ativos (from atendente data)
    if (atendenteData?.labels?.length) {
      // Count attendants with at least one call
      const activeAttendees = atendenteData.counts.filter(count => count > 0).length;
      kpiUpdate.atendentesAtivos = activeAttendees.toString();
    }
    
    // Update all KPI cards at once
    updateKPICards(kpiUpdate);
    console.log('KPI cards updated comprehensively:', kpiUpdate);
    
  } catch (error) {
    console.error('Error updating KPIs comprehensively:', error);
  }
}

/* Botões e eventos */
document.getElementById('btnAplicar').addEventListener('click', () => {
  loadDuvida(); loadDia(); loadComparativo(); loadHorarios(); loadAtendentes();
  // Update KPIs after all charts are loaded
  setTimeout(updateAllKPIs, 1000);
});
document.getElementById('btnLimpar').addEventListener('click', () => {
  elStart.value = ''; elEnd.value = '';
  Array.from(elTipos.options).forEach(o=>o.selected=false);
  loadDuvida(); loadDia(); loadComparativo(); loadHorarios(); loadAtendentes();
  // Update KPIs after all charts are loaded
  setTimeout(updateAllKPIs, 1000);
});

document.getElementById('btnTipoBar').addEventListener('click', () => {
  window._tipoDuvida = 'bar';
  loadDuvida();
});
document.getElementById('btnTipoPie').addEventListener('click', () => {
  window._tipoDuvida = 'pie';
  loadDuvida();
});

document.getElementById('chkMedia').addEventListener('change', () => {
  loadDia();
});

document.getElementById('btnZoomReset').addEventListener('click', () => {
  if (chartDia) chartDia.resetZoom();
});

document.getElementById('btnTipoDownload').addEventListener('click', () => {
  if (!chartDuvida) return;
  const url = chartDuvida.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'por_tipo.png'; a.click();
});

document.getElementById('btnDiaDownload').addEventListener('click', () => {
  if (!chartDia) return;
  const url = chartDia.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'por_dia.png'; a.click();
});

/* Carrega inicial - Only if Chart.js is available */
document.addEventListener('DOMContentLoaded', function() {
  // Wait for Chart.js to be available
  let checkAttempts = 0;
  const maxAttempts = 10;
  
  function checkAndInitialize() {
    checkAttempts++;
    if (typeof Chart !== 'undefined') {
      console.log('Chart.js is available, initializing charts...');
      loadDuvida(); 
      loadDia(); 
      loadComparativo(); 
      loadHorarios(); 
      loadAtendentes();
      // Update KPIs after initial chart loading
      setTimeout(updateAllKPIs, 1500);
    } else if (checkAttempts < maxAttempts) {
      setTimeout(checkAndInitialize, 500);
    } else {
      console.warn('Chart.js not available after waiting, charts will show as tables');
      // Initialize with fallback tables
      loadDuvida(); 
      loadDia(); 
      loadComparativo(); 
      loadHorarios(); 
      loadAtendentes();
      // Still try to update KPIs
      setTimeout(updateAllKPIs, 1000);
    }
  }
  
  checkAndInitialize();
});

// Event listeners para novos controles
document.getElementById('selPeriodo').addEventListener('change', () => {
  loadComparativo();
});

// Atendente chart type toggles
document.getElementById('btnAtendenteBarra').addEventListener('click', () => {
  window._tipoAtendente = 'bar';
  loadAtendentes();
});
document.getElementById('btnAtendentePizza').addEventListener('click', () => {
  window._tipoAtendente = 'pie';
  loadAtendentes();
});

// Download buttons for new charts
document.getElementById('btnComparativoDownload').addEventListener('click', () => {
  if (!window.chartComparativo) return;
  const url = window.chartComparativo.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'comparativo_periodo.png'; a.click();
});

document.getElementById('btnHorarioDownload').addEventListener('click', () => {
  if (!window.chartHorario) return;
  const url = window.chartHorario.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'pico_horarios.png'; a.click();
});

document.getElementById('btnAtendenteDownload').addEventListener('click', () => {
  if (!window.chartAtendente) return;
  const url = window.chartAtendente.toBase64Image();
  const a = document.createElement('a');
  a.href = url; a.download = 'por_atendente.png'; a.click();
});

// Export buttons
document.getElementById('btnExportCSVResumo').addEventListener('click', () => {
  exportData('por_duvida', 'csv');
});

document.getElementById('btnExportPDFResumo').addEventListener('click', () => {
  exportData('por_duvida', 'pdf');
});

document.getElementById('btnExportCSVDetalhado').addEventListener('click', () => {
  exportData('detalhado', 'csv');
});

document.getElementById('btnExportPDFDetalhado').addEventListener('click', () => {
  exportData('detalhado', 'pdf');
});
</script>
{% endblock %}
